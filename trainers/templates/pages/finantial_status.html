{% extends 'base/base.html' %}
{% load static %}

{% block title %}تقرير الحالة المالية{% endblock %}

{% block content %}
<!-- CSRF Token -->
{% csrf_token %}

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
body {
    font-family: 'Cairo', sans-serif;
    background-color: #f9f9f9;
    color: #333;
}

.container {
    max-width: 100%;
    padding: 0 10px;
}

.page-header {
    background: linear-gradient(90deg, #007bff, #0056b3);
    color: white;
    padding: 20px 10px;
    border-radius: 8px;
    margin: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.table {
    width: 100%;
    min-width: 100%;
}

@media (max-width: 768px) {
    .table {
        font-size: 0.85rem;
    }
    .table td, .table th {
        padding: 0.5rem;
        white-space: nowrap;
    }
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
}

@media (max-width: 576px) {
    .chart-container {
        height: 250px;
    }
}

.card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
}

.summary-card {
    transition: transform 0.2s;
}

.summary-card:hover {
    transform: translateY(-5px);
}

.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    height: 20px;
    border-radius: 4px;
    margin: 10px 0;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>

<div class="container">
    <!-- Page Header -->
    <div class="page-header text-center">
        <h1>تقرير الحالة المالية</h1>
        <img src="{% static 'images/logo/logo.png' %}" alt="شعار النادي" width="100" class="my-3">
        <p id="report-period">نظرة شاملة على الأداء المالي للنادي</p>
        <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#periodModal">
            تحديد الفترة الزمنية
        </button>
    </div>

    <!-- Date Selection Modal -->
    <div class="modal fade" id="periodModal" tabindex="-1" aria-labelledby="periodModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="periodModalLabel">حدد الفترة الزمنية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="start-date" class="form-label">تاريخ البداية</label>
                        <input type="text" id="start-date" class="form-control datepicker" aria-label="تاريخ البداية" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="mb-3">
                        <label for="end-date" class="form-label">تاريخ النهاية</label>
                        <input type="text" id="end-date" class="form-control datepicker" aria-label="تاريخ النهاية" placeholder="YYYY-MM-DD">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="applyDateRange">تأكيد</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
        <p class="mt-3 text-muted">جاري تحميل التقرير المالي...</p>
    </div>

    <!-- Main Content Container -->
    <div id="reportContent" style="display: none;">
        <!-- Financial Summary -->
        <section class="mb-4">
            <h2 class="text-center">الملخص المالي</h2>
            <div class="row text-center">
                <div class="col-12 col-md-4 mb-3">
                    <div class="card bg-success text-white p-3 summary-card">
                        <h4>الإيرادات</h4>
                        <p class="fs-4 fw-bold" id="total-income">0 DH</p>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-3">
                    <div class="card bg-danger text-white p-3 summary-card">
                        <h4>المصروفات</h4>
                        <p class="fs-4 fw-bold" id="total-expenses">0 DH</p>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-3">
                    <div class="card bg-primary text-white p-3 summary-card">
                        <h4>الفائض/العجز</h4>
                        <p class="fs-4 fw-bold" id="net-profit">0 DH</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Income Details -->
        <section class="mb-4">
            <h2 class="text-center">تفاصيل الإيرادات</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الوصف</th>
                            <th>التفاصيل</th>
                            <th>المبلغ</th>
                        </tr>
                    </thead>
                    <tbody id="income-tbody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Expenses Details -->
        <section class="mb-4">
            <h2 class="text-center">تفاصيل المصروفات</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>العنوان</th>
                            <th>الوصف</th>
                            <th>التاريخ</th>
                            <th>المبلغ</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-tbody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Charts -->
        <section class="mb-4">
            <h2 class="text-center">الرسوم البيانية</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <h3 class="text-center">الإيرادات</h3>
                    <div class="chart-container">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h3 class="text-center">المصروفات</h3>
                    <div class="chart-container">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
class FinancialReportManager {
    constructor() {
        this.startDate = '2025-01-01';
        this.endDate = '2025-12-31';
        this.charts = {
            income: null,
            expenses: null
        };
        this.init();
    }

    async init() {
        // Initialize date pickers (without Arabic locale since it's not available by default)
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true,
        });

        // Set default dates
        const today = new Date();
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        const endOfYear = new Date(today.getFullYear(), 11, 31);
        
        this.startDate = startOfYear.toISOString().split('T')[0];
        this.endDate = endOfYear.toISOString().split('T')[0];
        
        document.getElementById('start-date').value = this.startDate;
        document.getElementById('end-date').value = this.endDate;

        // Setup event listeners
        document.getElementById('applyDateRange').addEventListener('click', () => {
            this.updateDateRange();
        });

        // Load initial report
        await this.loadReport();
    }

    updateDateRange() {
        this.startDate = document.getElementById('start-date').value;
        this.endDate = document.getElementById('end-date').value;

        if (this.startDate && this.endDate) {
            document.getElementById('report-period').textContent = 
                `نظرة شاملة على الأداء المالي للنادي من ${this.startDate} إلى ${this.endDate}`;
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('periodModal')).hide();
            
            // Reload report
            this.loadReport();
        }
    }

    async loadReport() {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';

        try {
            const params = new URLSearchParams({
                start: this.startDate,
                end: this.endDate
            });

            const response = await fetch(`/api/financial-report/?${params}`);
            const data = await response.json();

            if (data.success === false) {
                throw new Error(data.error);
            }

            this.renderReport(data);

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('reportContent').style.display = 'block';

        } catch (error) {
            console.error('Error loading report:', error);
            document.getElementById('loadingIndicator').innerHTML = `
                <div class="alert alert-danger">
                    حدث خطأ أثناء تحميل التقرير. يرجى المحاولة مرة أخرى.
                </div>
            `;
        }
    }

    renderReport(data) {
        // Update summary cards
        document.getElementById('total-income').textContent = 
            `${data.summary.total_income.toFixed(2)} DH`;
        document.getElementById('total-expenses').textContent = 
            `${data.summary.total_costs.toFixed(2)} DH`;
        document.getElementById('net-profit').textContent = 
            `${data.summary.net_profit.toFixed(2)} DH`;

        // Render income table
        this.renderIncomeTable(data.income);

        // Render expenses table
        this.renderExpensesTable(data.expenses);

        // Render charts
        this.renderCharts(data);
    }

    renderIncomeTable(income) {
        const tbody = document.getElementById('income-tbody');
        let html = '';
        let rowNum = 1;

        // Payments row - show payment counts, not trainer counts
        const paymentsDetails = `
            <div>الكبار: ${income.payments.by_category.big}</div>
            <div>الفتيان: ${income.payments.by_category.med}</div>
            <div>الصغار: ${income.payments.by_category.small}</div>
            <div>النساء: ${income.payments.by_category.women}</div>
        `;
        
        html += `
            <tr>
                <td>${rowNum++}</td>
                <td>اشتراكات الأعضاء</td>
                <td>${paymentsDetails}</td>
                <td>${income.payments.total.toFixed(2)} DH</td>
            </tr>
        `;

        // Articles row
        html += `
            <tr>
                <td>${rowNum++}</td>
                <td>الدورات التدريبية والاختبارات</td>
                <td>العدد: ${income.articles.count}</td>
                <td>${income.articles.total.toFixed(2)} DH</td>
            </tr>
        `;

        // Added payments
        income.added_payments.items.forEach(payment => {
            html += `
                <tr>
                    <td>${rowNum++}</td>
                    <td>${payment.title}</td>
                    <td>${payment.description || '-'}</td>
                    <td>${payment.amount.toFixed(2)} DH</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    renderExpensesTable(expenses) {
        const tbody = document.getElementById('expenses-tbody');
        let html = '';
        let rowNum = 1;

        // Articles costs
        html += `
            <tr>
                <td>${rowNum++}</td>
                <td>الدورات التدريبية والاختبارات</td>
                <td>-</td>
                <td>-</td>
                <td>${expenses.articles.total.toFixed(2)} DH</td>
            </tr>
        `;

        // Regular costs
        expenses.costs.items.forEach(cost => {
            html += `
                <tr>
                    <td>${rowNum++}</td>
                    <td>${cost.title}</td>
                    <td>${cost.description}</td>
                    <td>${cost.date}</td>
                    <td>${cost.amount.toFixed(2)} DH</td>
                </tr>
            `;
        });

        // Staff salaries
        expenses.staff.members.forEach(member => {
            html += `
                <tr>
                    <td>${rowNum++}</td>
                    <td>${member.name}</td>
                    <td>${member.months} شهر</td>
                    <td>-</td>
                    <td>${member.total.toFixed(2)} DH</td>
                </tr>
            `;
        });

        // Rent
        html += `
            <tr>
                <td>${rowNum++}</td>
                <td>الإيجار</td>
                <td>${expenses.rent.months} شهر</td>
                <td>-</td>
                <td>${expenses.rent.total.toFixed(2)} DH</td>
            </tr>
        `;

        tbody.innerHTML = html;
    }

    renderCharts(data) {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(2) + ' DH';
                        }
                    }
                }
            }
        };

        // Destroy existing charts
        if (this.charts.income) this.charts.income.destroy();
        if (this.charts.expenses) this.charts.expenses.destroy();

        // Income Chart
        const incomeCtx = document.getElementById('incomeChart').getContext('2d');
        this.charts.income = new Chart(incomeCtx, {
            type: 'pie',
            data: {
                labels: ['اشتراكات', 'الأنشطة', 'أخرى'],
                datasets: [{
                    data: [
                        data.income.payments.total,
                        data.income.articles.total,
                        data.income.added_payments.total
                    ],
                    backgroundColor: ['#007bff', '#28a745', '#ffc107']
                }]
            },
            options: chartOptions
        });

        // Expenses Chart
        const expensesCtx = document.getElementById('expensesChart').getContext('2d');
        this.charts.expenses = new Chart(expensesCtx, {
            type: 'pie',
            data: {
                labels: ['رواتب', 'إيجار', 'الأنشطة', 'أخرى'],
                datasets: [{
                    data: [
                        data.expenses.staff.total,
                        data.expenses.rent.total,
                        data.expenses.articles.total,
                        data.expenses.costs.total
                    ],
                    backgroundColor: ['#dc3545', '#17a2b8', '#6c757d', '#df73ff']
                }]
            },
            options: chartOptions
        });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    new FinancialReportManager();
});
</script>

{% endblock %}