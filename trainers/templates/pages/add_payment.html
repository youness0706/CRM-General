{% extends 'base/base.html' %}
{% load static %}

{% block title %}إضافة الدفع{% endblock %}

{% block content %}
<!-- CSRF Token -->
{% csrf_token %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
body {
    background-color: #f8f9fa;
    font-family: 'Cairo', Arial, sans-serif;
}

.form-container {
    max-width: 600px;
    margin: 50px auto;
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.form-container h2 {
    margin-bottom: 30px;
    font-weight: bold;
    text-align: center;
    color: #007bff;
}

.btn-primary {
    background-color: #007bff;
    border: none;
    padding: 12px;
    font-size: 1.1rem;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.form-label {
    font-weight: 600;
    color: #333;
}

.select2-container {
    width: 100% !important;
}

.select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
}

.success-message {
    display: none;
    padding: 15px;
    margin-bottom: 20px;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 5px;
    color: #155724;
}

.error-message {
    display: none;
    padding: 15px;
    margin-bottom: 20px;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
    color: #721c24;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}
</style>

<div class="form-container">
    <h2>إضافة الدفع</h2>
    
    <!-- Success Message -->
    <div id="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i> تم إضافة الدفع بنجاح!
    </div>
    
    <!-- Error Message -->
    <div id="errorMessage" class="error-message">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
    </div>
    
    <form id="paymentForm" method="POST">
        {% csrf_token %}

        <div class="mb-3">
            <label for="trainer" class="form-label">المتدرب: *</label>
            <select name="trainer" id="trainer" class="form-control" required>
                <option value="" disabled selected>ابحث عن المتدرب...</option>
            </select>
            <small class="form-text text-muted">ابدأ الكتابة للبحث عن المتدرب بالاسم</small>
        </div>

        <div class="mb-3">
            <label for="paymentdate" class="form-label">تاريخ الدفع: *</label>
            <input type="date" name="paymentdate" id="paymentdate" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="paymentCategry" class="form-label">فئة الدفع: *</label>
            <select name="paymentCategry" id="paymentCategry" class="form-control" required>
                <option value="month" selected>شهرية</option>
                <option value="subscription">انخراط</option>
                <option value="assurance">التأمين</option>
                <option value="jawaz">جواز</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="paymentAmount" class="form-label">مبلغ الدفع (DH): *</label>
            <input 
                type="number" 
                name="paymentAmount" 
                id="paymentAmount" 
                class="form-control" 
                placeholder="أدخل المبلغ" 
                min="0"
                step="0.01"
                required
            >
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
            <span id="submitText">إضافة</span>
            <span id="submitSpinner" style="display: none;">
                <span class="spinner-border spinner-border-sm me-2"></span>
                جاري الحفظ...
            </span>
        </button>
    </form>
    
    <div class="mt-3 text-center">
        <a href="{% url 'payments_history' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> العودة إلى قائمة الدفعات
        </a>
    </div>
</div>

{% block extra_js %}
<!-- Load jQuery first -->
<!-- Load Select2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
// Arabic translations for Select2
$.fn.select2.amd.define('select2/i18n/ar', [], function() {
    return {
        errorLoading: function() {
            return 'لا يمكن تحميل النتائج';
        },
        inputTooLong: function(args) {
            return 'الرجاء حذف ' + (args.input.length - args.maximum) + ' عناصر';
        },
        inputTooShort: function(args) {
            return 'الرجاء إضافة ' + (args.minimum - args.input.length) + ' عناصر أو أكثر';
        },
        loadingMore: function() {
            return 'جاري تحميل نتائج إضافية...';
        },
        maximumSelected: function(args) {
            return 'تستطيع إختيار ' + args.maximum + ' بنود فقط';
        },
        noResults: function() {
            return 'لم يتم العثور على أي نتائج';
        },
        searching: function() {
            return 'جاري البحث…';
        },
        removeAllItems: function() {
            return 'قم بإزالة كل العناصر';
        }
    };
});

// Guard against multiple declarations (e.g., browser extensions or double-includes)
if (typeof window.PaymentFormManager === 'undefined') {
    (function() {
        class PaymentFormManager {
            constructor() {
                this.form = document.getElementById('paymentForm');
                this.submitBtn = document.getElementById('submitBtn');
                this.trainerSelect = $('#trainer');
                this.init();
            }

            init() {
                console.log('Initializing PaymentFormManager');
                this.initSelect2();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('paymentdate').value = today;
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });
            }

            initSelect2() {
                console.log('Initializing Select2');
                this.trainerSelect.select2({
                    theme: 'bootstrap-5',
                    placeholder: 'ابحث عن المتدرب...',
                    dir: 'rtl',
                    language: 'ar',
                    allowClear: true,
                    minimumInputLength: 0,
                    width: '100%',
                    ajax: {
                        url: '{% url "api_trainers_for_payment" %}',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return { search: params.term || '', page: params.page || 1 };
                        },
                        processResults: function(data, params) {
                            params.page = params.page || 1;
                            if (!data.results) return { results: [], pagination: { more: false } };
                            return { results: data.results, pagination: { more: data.pagination && data.pagination.more } };
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX Error:', { status: xhr.status, statusText: xhr.statusText, error: error, response: xhr.responseText });
                        },
                        cache: true
                    },
                    templateResult: function(trainer) { return trainer.loading ? trainer.text : trainer.text; },
                    templateSelection: function(trainer) { return trainer.text; }
                });

                this.trainerSelect.on('select2:select', function(e) { console.log('Trainer selected:', e.params.data); });
                this.trainerSelect.on('select2:open', function() { setTimeout(function() { const f = document.querySelector('.select2-search__field'); if (f) f.focus(); }, 100); });
                this.trainerSelect.on('select2:error', function(e) { console.error('Select2 error event:', e); });
            }

            async handleSubmit() {
                console.log('Form submitted');
                if (!this.form.checkValidity()) { this.form.reportValidity(); return; }
                const trainerValue = this.trainerSelect.val();
                if (!trainerValue) { this.showError('الرجاء اختيار المتدرب'); return; }
                this.submitBtn.disabled = true; document.getElementById('submitText').style.display = 'none'; document.getElementById('submitSpinner').style.display = 'inline'; this.hideMessages();
                try {
                    const formData = new FormData(this.form);
                    const response = await fetch('{% url "add_payment" %}', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (response.redirected) { window.location.href = response.url; return; }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.success === false) throw new Error(data.error || 'حدث خطأ أثناء إضافة الدفع');
                        this.showSuccess(); setTimeout(() => { window.location.href = '{% url "payments_history" %}'; }, 1500);
                    } else { throw new Error('حدث خطأ غير متوقع'); }
                } catch (error) { console.error('Submit error:', error); this.showError(error.message || 'حدث خطأ أثناء إضافة الدفع'); }
                finally { this.submitBtn.disabled = false; document.getElementById('submitText').style.display = 'inline'; document.getElementById('submitSpinner').style.display = 'none'; }
            }

            showSuccess() { document.getElementById('successMessage').style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' }); }
            showError(message) { document.getElementById('errorText').textContent = message; document.getElementById('errorMessage').style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' }); }
            hideMessages() { document.getElementById('successMessage').style.display = 'none'; document.getElementById('errorMessage').style.display = 'none'; }
        }

        // export class to window and initialize once
        window.PaymentFormManager = PaymentFormManager;
        if (!window._paymentFormManagerInitialized) {
            window._paymentFormManagerInitialized = true;
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => new window.PaymentFormManager()); else new window.PaymentFormManager();
        }
    })();
} else {
    // If class already exists, ensure a single instance is created
    if (!window._paymentFormManagerInitialized) {
        window._paymentFormManagerInitialized = true;
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => new window.PaymentFormManager()); else new window.PaymentFormManager();
    } else {
        console.log('PaymentFormManager already initialized');
    }
}
</script>
{% endblock %}
{% endblock %}
